# Codex MCPåŒ–ã«ã‚ˆã‚‹ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆè¨­è¨ˆæ›¸

**æ—¥ä»˜**: 2025-10-11  
**ææ¡ˆè€…**: User  
**è¨­è¨ˆè€…**: AI Assistant (Claude Sonnet 4.5)  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš§ å®Ÿè£…ä¸­

---

## ğŸ¯ æ¦‚è¦

**å•é¡Œ**: Codexå†…éƒ¨APIãŒPrivateã®ãŸã‚ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã›ãªã„

**è§£æ±ºç­–**: **Codexè‡ªä½“ã‚’MCPã‚µãƒ¼ãƒãƒ¼åŒ–**ã—ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒMCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦å‘¼ã³å‡ºã™

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Before (ç¾åœ¨ã®å®Ÿè£…)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sub-Agent       â”‚
â”‚ (AgentRuntime)  â”‚
â”‚                 â”‚
â”‚ ModelClient â”€â”€â”€â”€â”¼â”€â”€> LLM API
â”‚ (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§    â”‚
â”‚  ãƒ„ãƒ¼ãƒ«èª¬æ˜)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âŒ Private APIåˆ¶é™
     âŒ ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œä¸å¯
```

### After (MCPåŒ–è¨­è¨ˆ)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sub-Agent       â”‚  MCP   â”‚ Codex MCP Server â”‚
â”‚ (AgentRuntime)  â”‚ â—„â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                 â”‚ stdio  â”‚ âœ… read_file      â”‚
â”‚ + MCP Client    â”‚        â”‚ âœ… grep          â”‚
â”‚                 â”‚        â”‚ âœ… codebase_searchâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ âœ… apply_patch   â”‚
     âœ… æ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«        â”‚ âœ… shell         â”‚
     âœ… å®Œå…¨ãªãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ… æ¨©é™ç®¡ç†             â”‚
                           â”‚ Codex Core
                           â”‚ (æ—¢å­˜ã®å…¨æ©Ÿèƒ½)
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## ğŸ“‹ å®Ÿè£…è¨ˆç”»

### âœ… Phase 1: Codex MCP Tools å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `codex-rs/mcp-server/src/codex_tools.rs`

**å®Ÿè£…å†…å®¹**:
```rust
pub struct CodexMcpTool {
    pub name: String,
    pub description: String,
    pub input_schema: Value,
}

// å®šç¾©æ¸ˆã¿ãƒ„ãƒ¼ãƒ«:
// - codex_read_file       (safe, read-only)
// - codex_grep            (safe, read-only)
// - codex_codebase_search (safe, read-only)
// - codex_apply_patch     (requires write permission)
// - codex_shell           (requires shell permission)
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†

---

### ğŸš§ Phase 2: AgentRuntime ã« MCP Client çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `codex-rs/core/src/agents/runtime.rs`

**å¤‰æ›´å†…å®¹**:
```rust
use codex_mcp_client::Client as McpClient;

pub struct AgentRuntime {
    // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    loader: Arc<RwLock<AgentLoader>>,
    budgeter: Arc<TokenBudgeter>,
    
    // ğŸ†• è¿½åŠ 
    mcp_client: Option<Arc<McpClient>>,
    codex_mcp_server_path: PathBuf,
}

impl AgentRuntime {
    async fn execute_agent_with_mcp(
        &self,
        agent_def: &AgentDefinition,
        goal: &str,
    ) -> Result<Vec<String>> {
        // 1. Codex MCP ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
        let mcp_client = self.spawn_codex_mcp_server().await?;
        
        // 2. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ¨©é™ã«åŸºã¥ã„ã¦ãƒ„ãƒ¼ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let allowed_tools = self.filter_tools_by_permissions(
            &agent_def.tools.mcp
        );
        
        // 3. ModelClient + MCP Tools ã§LLMå‘¼ã³å‡ºã—
        let prompt = self.build_prompt_with_mcp_tools(
            agent_def,
            goal,
            &allowed_tools
        );
        
        // 4. ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—æ™‚ã«MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçµŒç”±ã§å®Ÿè¡Œ
        // ...
    }
    
    async fn spawn_codex_mcp_server(&self) -> Result<Arc<McpClient>> {
        // codex mcp-server ã‚’ stdio ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
        let mut child = Command::new(&self.codex_mcp_server_path)
            .arg("mcp-server")
            .stdin(Stdio::piped())
            .stdout(Stdio::piped())
            .spawn()?;
        
        let client = McpClient::new(
            child.stdin.take().unwrap(),
            child.stdout.take().unwrap()
        );
        
        Ok(Arc::new(client))
    }
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â³ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

---

### ğŸ”œ Phase 3: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `.codex/agents/code-reviewer.yaml`

**Before**:
```yaml
tools:
  mcp:
    - grep        # æ±ç”¨MCPãƒ„ãƒ¼ãƒ«
    - read_file   # æ±ç”¨MCPãƒ„ãƒ¼ãƒ«
```

**After**:
```yaml
tools:
  mcp:
    # Codexå°‚ç”¨MCPãƒ„ãƒ¼ãƒ«ï¼ˆå®Œå…¨ãªCodexæ©Ÿèƒ½ï¼‰
    - codex_read_file       # âœ… CodexçµŒç”±ã§ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š
    - codex_grep            # âœ… CodexçµŒç”±ã§grep
    - codex_codebase_search # âœ… ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢
    # codex_shell ã¯è¨±å¯ã—ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
```

---

### ğŸ”œ Phase 4: æ¨©é™ãƒã‚§ãƒƒã‚¯çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `codex-rs/core/src/agents/permission_checker.rs`

**è¿½åŠ æ©Ÿèƒ½**:
```rust
impl PermissionChecker {
    pub fn check_codex_mcp_tool(&self, tool_name: &str) -> Result<()> {
        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã® tools.mcp ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if self.permissions.mcp.contains(&tool_name.to_string()) {
            Ok(())
        } else {
            Err(anyhow!(
                "Codex MCP tool '{}' is not permitted for this agent",
                tool_name
            ))
        }
    }
}
```

---

## ğŸ åˆ©ç‚¹

### 1. **Private APIå•é¡Œã®å®Œå…¨è§£æ±º**
```
âŒ æ—§: crate::codex::Codex (Private)
âœ… æ–°: MCP Protocol (Standard)
```

### 2. **æ—¢å­˜å®Ÿè£…ã®å†åˆ©ç”¨**
- `codex mcp-server` ã‚³ãƒãƒ³ãƒ‰ï¼ˆæ—¢å­˜ï¼‰
- `codex-mcp-client` ã‚¯ãƒ¬ãƒ¼ãƒˆï¼ˆæ—¢å­˜ï¼‰
- Codex Core ã®å…¨æ©Ÿèƒ½ï¼ˆæ—¢å­˜ï¼‰

### 3. **æ˜ç¢ºãªæ¨©é™ç®¡ç†**
```yaml
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«åˆ¥ã®ãƒ„ãƒ¼ãƒ«åˆ†é¡
safe_tools:          # èª­ã¿å–ã‚Šã®ã¿
  - codex_read_file
  - codex_grep
  - codex_codebase_search

moderate_tools:      # æ›¸ãè¾¼ã¿å¯èƒ½
  - codex_apply_patch

dangerous_tools:     # ã‚·ã‚§ãƒ«å®Ÿè¡Œ
  - codex_shell      # é€šå¸¸ã¯è¨±å¯ã—ãªã„
```

### 4. **ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã®å‘ä¸Š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sub-Agent Process   â”‚ â† åˆ¶é™ã•ã‚ŒãŸç’°å¢ƒ
â”‚ (MCP Client)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ MCP over stdio
           â”‚ (ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Codex MCP Server    â”‚ â† å®Œå…¨ãªæ¨©é™
â”‚ (Parent Process)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. **ãƒ†ã‚¹ãƒˆã®å®¹æ˜“æ€§**
```rust
#[tokio::test]
async fn test_agent_with_mock_mcp() {
    // MockMcpServer ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
    let mock_server = MockCodexMcpServer::new();
    let runtime = AgentRuntime::new_with_mcp(mock_server);
    // ...
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. **ãƒ„ãƒ¼ãƒ«æ¨©é™ã®éšå±¤åŒ–**

```yaml
# Level 1: Safe (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨±å¯)
codex_read_file
codex_grep
codex_codebase_search

# Level 2: Moderate (æ˜ç¤ºçš„è¨±å¯å¿…è¦)
codex_apply_patch
codex_write_file

# Level 3: Dangerous (å³æ ¼ãªå¯©æŸ»å¿…è¦)
codex_shell
codex_delete_file
```

### 2. **å®Ÿè¡Œæ™‚ãƒã‚§ãƒƒã‚¯**

```rust
// AgentRuntime ã§äºŒé‡ãƒã‚§ãƒƒã‚¯
fn check_tool_call(&self, tool_name: &str) -> Result<()> {
    // 1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ãƒã‚§ãƒƒã‚¯
    self.permission_checker.check_mcp_tool(tool_name)?;
    
    // 2. å®Ÿè¡Œæ™‚ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯
    self.runtime_policy.check_tool(tool_name)?;
    
    // 3. ãƒˆãƒ¼ã‚¯ãƒ³äºˆç®—ãƒã‚§ãƒƒã‚¯
    self.budgeter.check_remaining()?;
    
    Ok(())
}
```

### 3. **ç›£æŸ»ãƒ­ã‚°**

```rust
// å…¨MCPãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’ãƒ­ã‚°
log_audit_event(AuditEvent::new(
    agent_name,
    AuditEventType::McpToolCall {
        tool: "codex_shell".to_string(),
        args: serde_json::json!({"command": "ls"}),
        result: "success",
    }
));
```

---

## ğŸ“Š å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### ğŸ¯ çŸ­æœŸ (1-2æ—¥)
- [x] Phase 1: Codex MCP Tools å®šç¾©
- [ ] Phase 2: AgentRuntime MCPçµ±åˆ
- [ ] Phase 3: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©æ›´æ–°
- [ ] Phase 4: åŸºæœ¬ãƒ†ã‚¹ãƒˆ

### ğŸš€ ä¸­æœŸ (1é€±é–“)
- [ ] å®Œå…¨ãªæ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- [ ] ç›£æŸ»ãƒ­ã‚°çµ±åˆ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

### â­ é•·æœŸ (1ãƒ¶æœˆ)
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [ ] ä¸¦åˆ—å®Ÿè¡Œã‚µãƒãƒ¼ãƒˆ
- [ ] ã‚«ã‚¹ã‚¿ãƒ MCPãƒ„ãƒ¼ãƒ«å®šç¾©
- [ ] ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰çµ±åˆ

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### Unit Tests
```rust
#[tokio::test]
async fn test_codex_mcp_tool_definition() {
    let tools = CodexMcpTool::safe_tools();
    assert_eq!(tools.len(), 3);
}

#[tokio::test]
async fn test_agent_runtime_mcp_spawn() {
    let runtime = AgentRuntime::new(...);
    let client = runtime.spawn_codex_mcp_server().await.unwrap();
    // MCPã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
}
```

### Integration Tests
```bash
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆMCPçµŒç”±ï¼‰
codex delegate code-reviewer \
  --goal "Review code with Codex MCP tools" \
  --scope ./src

# æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:
# 1. Codex MCPã‚µãƒ¼ãƒãƒ¼ãŒè‡ªå‹•èµ·å‹•
# 2. code-reviewer ãŒ codex_read_file ã‚’å‘¼ã³å‡ºã—
# 3. code-reviewer ãŒ codex_grep ã‚’å‘¼ã³å‡ºã—
# 4. code-reviewer ãŒ codex_codebase_search ã‚’å‘¼ã³å‡ºã—
# 5. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
```

---

## ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

### SUBAGENTS_QUICKSTART.md
```markdown
## Codex MCP Integration

Sub-agents can use Codex's full capabilities via MCP:

\`\`\`yaml
# .codex/agents/my-agent.yaml
tools:
  mcp:
    - codex_read_file
    - codex_grep
    - codex_codebase_search
\`\`\`

These tools provide:
- âœ… Full Codex functionality
- âœ… Proper sandboxing
- âœ… Permission management
- âœ… Audit logging
```

---

## ğŸ‰ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### Before (ç¾çŠ¶)
```
âŒ Private APIåˆ¶é™
âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ãƒ„ãƒ¼ãƒ«èª¬æ˜ã®ã¿
âŒ å®Ÿéš›ã®ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œä¸å¯
âš ï¸  TODO ã‚³ãƒ¡ãƒ³ãƒˆã ã‚‰ã‘
```

### After (MCPåŒ–å¾Œ)
```
âœ… æ¨™æº–MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«
âœ… å®Œå…¨ãªãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
âœ… æ¨©é™ãƒ™ãƒ¼ã‚¹ã®åˆ¶å¾¡
âœ… ç›£æŸ»ãƒ­ã‚°å®Œå‚™
âœ¨ Production Ready
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### æ–°è¦ä½œæˆ
- `codex-rs/mcp-server/src/codex_tools.rs`
- `_docs/2025-10-11_CodexMCPåŒ–è¨­è¨ˆæ›¸.md`

### å¤‰æ›´äºˆå®š
- `codex-rs/core/src/agents/runtime.rs`
- `codex-rs/mcp-server/src/lib.rs`
- `.codex/agents/*.yaml`
- `SUBAGENTS_QUICKSTART.md`

---

## ğŸ’¡ ä»Šå¾Œã®æ‹¡å¼µ

### 1. ã‚«ã‚¹ã‚¿ãƒ Codexãƒ„ãƒ¼ãƒ«
```yaml
tools:
  mcp:
    - codex_custom:my_analyzer  # ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«å®šç¾©
```

### 2. ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³
```yaml
tools:
  mcp:
    - codex_grep â†’ codex_read_file â†’ codex_apply_patch
  # è‡ªå‹•çš„ã«ãƒ„ãƒ¼ãƒ«ã‚’é€£é–å®Ÿè¡Œ
```

### 3. ä¸¦åˆ—å®Ÿè¡Œ
```yaml
delegation:
  parallel: true  # è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸¦åˆ—å®Ÿè¡Œ
  tools:
    - codex_*  # åŒæ™‚ã«Codexãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—
```

---

**Project**: zapabob/codex  
**Version**: 0.47.0-alpha.1 â†’ 0.47.0-alpha.2 (äºˆå®š)  
**Status**: ğŸš§ å®Ÿè£…ä¸­  
**Completion Target**: 2025-10-12


