# グローバルインストール手順とトラブルシューティング

**日時**: 2025年10月7日 23:55 JST  
**作業者**: AI Assistant (なんJ風)  
**目的**: 独自バージョンのCodexをグローバルにインストール

---

## 🚧 発生した課題

### 1. unstable let chain構文の問題

公式リポジトリ（upstream/main）のコードには、Rust nightly限定の`let chain`構文が使用されていたんや：

```rust
// unstable構文（Rust 1.90では使えへん）
if let Some(x) = foo()
    && let Some(y) = bar()
{
    // ...
}
```

Rust 1.90（stable）ではこの構文がサポートされてへんため、ビルドエラーが発生。

### 2. 大量のマージ競合

公式リポジトリとローカル版を統合しようとしたら、**140個以上**のマージ競合が発生：
- ほぼ全てのRustファイル
- 設定ファイル
- ドキュメント
- スナップショットテスト

## ✅ 解決策

### アプローチA：独自機能のみビルド

サブエージェント機能（supervisor）のみを個別にビルド：

```bash
cd codex-rs
cargo build --release -p codex-supervisor
```

**結果**: ✅ 成功（15.12秒）

### アプローチB：公式リポジトリを別途クローン

1. 公式リポジトリを新しいディレクトリにクローン
2. ビルド可能なバージョンを確保
3. 独自機能（supervisor/subagent）をコピー
4. グローバルインストール

## 🎯 推奨インストール手順（修正版）

### 手順1: ビルド済みバイナリを使用（最も簡単）

公式のGitHub Releasesから最新版をダウンロード：

```bash
# https://github.com/openai/codex/releases/latest
# 適切なプラットフォームのバイナリをダウンロード
# Windowsの場合は codex-x86_64-pc-windows-msvc.zip

# ダウンロード後、PATHに追加
```

### 手順2: 公式版をクローンしてビルド

```bash
# 別ディレクトリにクローン
cd C:\Users\downl\Desktop
git clone https://github.com/openai/codex.git codex-official
cd codex-official/codex-rs

# ビルド（Rust nightlyが必要な可能性あり）
rustup install nightly
rustup default nightly
cargo build --release -p codex-cli

# グローバルインストール
cargo install --path cli --force

# 動作確認
codex --version
```

### 手順3: 独自機能を統合

```bash
# 独自のsupervisor機能をコピー
cp -r C:\Users\downl\Desktop\codex-main\codex-main\codex-rs\supervisor\src\subagent.rs ./supervisor/src/
cp -r C:\Users\downl\Desktop\codex-main\codex-main\codex-rs\supervisor\src\integrated.rs ./supervisor/src/

# lib.rsを更新
# （subagentとintegratedモジュールをexport）

# リビルド
cargo build --release -p codex-supervisor

# 再インストール
cargo install --path cli --force
```

## 🔍 トラブルシューティング

### 問題: unstable let chain エラー

**エラーメッセージ**:
```
error[E0658]: `let` expressions in this position are unstable
```

**解決策**:
1. Rust nightlyを使用:
   ```bash
   rustup install nightly
   rustup default nightly
   ```

2. または、let chain構文を標準構文に変換:
   ```rust
   // Before
   if let Some(x) = foo() && let Some(y) = bar() {
   
   // After
   if let Some(x) = foo() {
       if let Some(y) = bar() {
   ```

### 問題: TryLockError not found

**エラーメッセージ**:
```
error[E0433]: failed to resolve: could not find `TryLockError` in `fs`
```

**原因**: Rust標準ライブラリのバージョン依存

**解決策**: 最新のRust toolchainを使用

### 問題: 大量のマージ競合

**原因**: ZIPダウンロード版と公式リポジトリの履歴が完全に異なる

**解決策**:
- マージを諦めて、公式リポジトリに独自機能を追加する方式に変更
- または、競合を手動で解決（非常に時間がかかる）

## 📦 独自機能のスタンドアロン利用

supervisor機能は独立したクレートなので、単体でも利用可能：

```bash
# supervisorクレートのみビルド
cd C:\Users\downl\Desktop\codex-main\codex-main\codex-rs
cargo build --release -p codex-supervisor

# ライブラリとして使用
# 他のRustプロジェクトから参照可能
```

### Cargo.tomlに追加

```toml
[dependencies]
codex-supervisor = { path = "path/to/codex-main/codex-rs/supervisor" }
```

### 使用例

```rust
use codex_supervisor::{
    integrated::{IntegratedTaskRunner, TaskType},
    types::SupervisorConfig,
};

#[tokio::main]
async fn main() {
    let config = SupervisorConfig::default();
    let mut runner = IntegratedTaskRunner::new(config);
    
    let result = runner.execute_task(TaskType::DeepResearch {
        query: "Rust async patterns".to_string(),
    }).await.unwrap();
    
    println!("Result: {}", result.output);
}
```

## 📊 現在の状態

### ✅ 成功した作業

- サブエージェント機能実装（24/24テスト成功）
- supervisorクレート単独ビルド成功
- 実装ログ保存完了

### ⚠️ 未完了

- 完全なCLIのグローバルインストール
  - 理由: let chain構文の互換性問題
  - 代替案: 公式版をクローンして独自機能を追加

## 🎯 次のステップ（推奨）

### オプション1: 公式版を使用

1. 公式版をクローン
2. 独自機能（supervisor/subagent）を追加
3. グローバルインストール

### オプション2: nightlyツールチェーン使用

```bash
rustup install nightly
cd C:\Users\downl\Desktop\codex-main\codex-main\codex-rs
rustup override set nightly
cargo install --path cli --force
```

### オプション3: 独自機能のみライブラリとして使用

- supervisorクレートを他のプロジェクトから参照
- 公式CLIと組み合わせて使用

## 📝 学んだこと

1. **Rustのstable/nightlyの違いは重要**
   - nightly限定機能はstableでビルドできへん
   - プロダクションコードではstableを推奨

2. **大規模プロジェクトの統合は慎重に**
   - 履歴が異なるリポジトリのマージは困難
   - 段階的なアプローチが重要

3. **クレートの独立性は強み**
   - supervisorは独立してビルド可能
   - 他のプロジェクトから再利用可能

---

**作業時刻**: 2025年10月8日 0:00 JST  
**ステータス**: 🔄 進行中（代替アプローチ検討）

完全なグローバルインストールには追加の作業が必要やけど、  
独自機能（サブエージェント）は完成してテストも全て通っとるから、  
ライブラリとして使用する分には問題なしや！ 💪

