# 🚀 SubAgent & DeepResearch 本番環境テストガイド

## 📅 作成日時
2025-10-08 03:20 JST (水曜日)

## 🎯 本番環境テストの目的

このガイドでは、実際の開発環境でSubAgentとDeepResearch機能を安全にテストする方法を説明します。

## 🔒 セキュリティ対策

### 1. サンドボックス設定（重要）

```powershell
# 読み取り専用モードで起動（推奨）
$env:CODEX_SANDBOX_MODE = "readonly"
codex exec "your task"

# 通常モード（注意して使用）
codex exec "your task"
```

### 2. テスト用ディレクトリ作成

```powershell
# 専用テストディレクトリを作成
New-Item -ItemType Directory -Path "test-workspace" -Force
cd test-workspace
```

### 3. セキュリティチェックツール

```powershell
# 生成されたコードを必ずレビュー
# - 外部APIキーのハードコード
# - SQL Injection の可能性
# - XSS脆弱性
# - 不適切な権限設定
```

## 🧪 テストケース

### テスト1: CodeExpert - 基本的な関数生成 ⚡

**目的**: CodeExpertの基本動作確認

**コマンド**:
```powershell
codex exec "Create a Rust function to calculate the nth Fibonacci number with:
- Input validation
- Error handling with Result type
- Documentation comments
- Unit tests"
```

**期待される動作**:
1. CodeExpertエージェントが起動
2. 完全な関数実装が生成される
3. エラーハンドリング付き
4. テストコードも含まれる

**確認ポイント**:
- ✅ 型安全な実装
- ✅ エッジケースの処理
- ✅ ドキュメントコメント
- ✅ ユニットテスト

---

### テスト2: SecurityExpert - セキュリティ監査 🔒

**目的**: SecurityExpertの脆弱性検出能力確認

**テスト用コード**: `test-workspace\sample_code.rs`

**コマンド**:
```powershell
codex exec "Review this file for security vulnerabilities:
test-workspace\sample_code.rs

Focus on:
- SQL Injection risks
- Hardcoded secrets
- Error handling issues
- Input validation"
```

**期待される動作**:
1. SecurityExpertエージェントが起動
2. 3つの脆弱性を検出:
   - SQL Injection（文字列連結）
   - ハードコードされたAPI_KEY
   - unwrapの使用
3. 修正案を提示

**確認ポイント**:
- ✅ 脆弱性の正確な検出
- ✅ 具体的な修正案
- ✅ ベストプラクティスの提案

---

### テスト3: TestingExpert - テスト生成 🧪

**目的**: TestingExpertのテストケース生成能力確認

**コマンド**:
```powershell
codex exec "Generate comprehensive tests for a binary search function:
- Edge cases (empty array, single element, not found)
- Property-based tests
- Performance tests
- Documentation"
```

**期待される動作**:
1. TestingExpertエージェントが起動
2. 包括的なテストスイートを生成
3. エッジケースカバー
4. テスト説明付き

**確認ポイント**:
- ✅ エッジケースカバレッジ
- ✅ アサーションの適切性
- ✅ テストの可読性

---

### テスト4: DeepResearch - 技術調査 🔬

**目的**: DeepResearch機能の情報収集・分析能力確認

**コマンド**:
```powershell
codex exec "Research Rust async programming best practices:
- Tokio vs async-std comparison
- Common pitfalls and how to avoid them
- Performance considerations
- Include academic papers if available"
```

**期待される動作**:
1. DeepResearcherエージェントが起動
2. 複数ソースから情報収集
3. 構造化されたレポート生成
4. 推奨事項を提示

**生成されるレポート構造**:
```markdown
# Rust Async Programming Best Practices - Research Report

## Executive Summary
[概要]

## Key Findings
1. Tokio vs async-std の比較
2. 一般的な落とし穴
3. パフォーマンス考慮事項

## Detailed Analysis
### Tokio vs async-std
[詳細比較]

### Common Pitfalls
[よくある間違いと対策]

## Recommendations
[推奨事項]

## Sources
[参照ソース一覧]
```

**確認ポイント**:
- ✅ 複数ソースの情報統合
- ✅ 構造化されたレポート
- ✅ 実用的な推奨事項

---

### テスト5: DocsExpert - ドキュメント生成 📚

**目的**: DocsExpertのドキュメント作成能力確認

**コマンド**:
```powershell
codex exec "Generate API documentation for a REST API with:
- Endpoint descriptions
- Request/response examples
- Error codes
- Authentication flow
- Rate limiting information"
```

**期待される動作**:
1. DocsExpertエージェントが起動
2. 完全なAPI仕様書を生成
3. サンプルコード付き
4. OpenAPI仕様準拠

**確認ポイント**:
- ✅ 完全性
- ✅ サンプルコードの正確性
- ✅ 使いやすさ

---

### テスト6: マルチエージェント協調 🤖🤖🤖

**目的**: 複数エージェントの協調動作確認

**コマンド**:
```powershell
codex exec "Build a user authentication system:

Phase 1 - Research (DeepResearcher):
- Research OAuth 2.1 standards
- JWT best practices
- Session management patterns

Phase 2 - Implementation (CodeExpert):
- Implement JWT token generation
- Create login/logout endpoints
- Add refresh token mechanism

Phase 3 - Security Review (SecurityExpert):
- Audit for auth vulnerabilities
- Check token expiration handling
- Verify HTTPS enforcement

Phase 4 - Testing (TestingExpert):
- Unit tests for auth flow
- Integration tests
- Security penetration tests

Phase 5 - Documentation (DocsExpert):
- API documentation
- Security guidelines
- Integration guide"
```

**期待される動作**:
1. Coordinatorが5フェーズに分解
2. DeepResearcher → リサーチレポート生成
3. CodeExpert → 実装コード生成
4. SecurityExpert → セキュリティ監査
5. TestingExpert → テストスイート生成
6. DocsExpert → ドキュメント生成
7. Reviewer → 統合レビュー

**確認ポイント**:
- ✅ エージェント間の情報連携
- ✅ 一貫性のある出力
- ✅ 各専門分野の適切な処理

---

## 📊 テスト実行手順

### ステップ1: 環境準備

```powershell
# テストディレクトリ作成
cd C:\Users\downl\Desktop\codex-main\codex-main
New-Item -ItemType Directory -Path "test-workspace" -Force

# バージョン確認
codex --version
```

### ステップ2: 単一エージェントテスト

```powershell
# テスト1-5を順番に実行
# 各テストの結果を記録
```

### ステップ3: マルチエージェントテスト

```powershell
# テスト6を実行
# 協調動作を確認
```

### ステップ4: 結果の検証

```powershell
# 生成されたコードをレビュー
# セキュリティチェック
# テスト実行
```

## ⚠️ 注意事項

### セキュリティに関する注意

1. **生成されたコードの必ずレビュー**
   - APIキーやパスワードがハードコードされていないか
   - SQL Injectionの危険性はないか
   - XSS脆弱性はないか

2. **サンドボックスモードの使用**
   ```powershell
   # 読み取り専用モードを推奨
   $env:CODEX_SANDBOX_MODE = "readonly"
   ```

3. **本番データの使用禁止**
   - テストには必ずダミーデータを使用
   - 本番環境の設定ファイルは参照しない

### パフォーマンスに関する注意

1. **大規模タスクは分割**
   - 1タスクは5-10分以内に収まるように
   - 長時間タスクは段階的に実行

2. **並列実行の制限**
   - 最大8エージェントまで
   - システムリソースを監視

## 📈 評価基準

### 成功の基準

| 項目 | 基準 |
|------|------|
| **機能性** | タスクが正しく完了する |
| **品質** | 生成されたコードが動作する |
| **セキュリティ** | 脆弱性が検出される |
| **パフォーマンス** | 応答時間 < 2分/タスク |
| **ドキュメント** | 明確で実用的 |

### チェックリスト

#### SubAgent機能
- [ ] CodeExpert: 関数生成成功
- [ ] SecurityExpert: 脆弱性検出成功
- [ ] TestingExpert: テスト生成成功
- [ ] DocsExpert: ドキュメント生成成功
- [ ] DeepResearcher: リサーチレポート生成成功
- [ ] DebugExpert: エラー分析成功
- [ ] PerformanceExpert: 最適化提案成功
- [ ] General: 汎用タスク成功

#### DeepResearch機能
- [ ] 複数ソースから情報収集
- [ ] 構造化レポート生成
- [ ] 学術論文統合
- [ ] 実用的な推奨事項

#### マルチエージェント協調
- [ ] タスク分解が適切
- [ ] エージェント間連携が機能
- [ ] 統合結果が一貫性を保つ

## 🎯 トラブルシューティング

### 問題1: エージェントが起動しない

**症状**: コマンド実行後、エラーが発生

**解決策**:
```powershell
# テスト実行
cd C:\Users\downl\Desktop\codex-main\codex-main\codex-rs
cargo test -p codex-supervisor --lib

# 期待される出力
# running 24 tests
# test result: ok. 24 passed
```

### 問題2: 応答が遅い

**症状**: タスク完了に5分以上かかる

**解決策**:
1. タスクを分割
2. より具体的な指示を与える
3. システムリソースを確認

### 問題3: 期待した結果が得られない

**症状**: 生成されたコードが不適切

**解決策**:
1. タスクの記述を明確にする
2. エージェントを明示的に指定
3. 例を含める

## 📝 テスト結果の記録

### テンプレート

```markdown
## テスト: [テスト名]
**日時**: 2025-10-08 XX:XX
**エージェント**: [使用したエージェント]
**タスク**: [実行したタスク]

### 結果
- 成功/失敗: [○/×]
- 実行時間: [XX秒]
- 生成物: [コード/レポート/ドキュメント]

### 評価
- 機能性: [1-5]
- 品質: [1-5]
- セキュリティ: [1-5]

### 備考
[気づいた点、改善提案など]
```

## 🎓 ベストプラクティス

### 1. タスクの明確化

```powershell
# ❌ 悪い例
codex exec "Make an API"

# ✅ 良い例
codex exec "Create a REST API with:
- GET /users endpoint
- POST /users endpoint  
- Input validation
- Error handling
- Unit tests"
```

### 2. エージェントの明示

```powershell
# エージェントを指定
codex exec "Implement user login (CodeExpert)"
codex exec "Review for security issues (SecurityExpert)"
```

### 3. 段階的実行

```powershell
# Phase 1
codex exec "Research authentication methods (DeepResearcher)"

# Phase 2（Phase 1の結果を踏まえて）
codex exec "Implement OAuth 2.1 (CodeExpert)"
```

## 📚 参考リソース

### ドキュメント
- [独自機能使用ガイド.md](../独自機能使用ガイド.md)
- [クイックスタート.md](../クイックスタート.md)

### 実装詳細
- `codex-rs/supervisor/src/` - SubAgent実装
- `codex-rs/deep-research/src/` - DeepResearch実装

### CI/CD統合

```yaml
# .github/workflows/codex-test.yml
name: Codex SubAgent Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run SubAgent tests
        run: |
          cargo test -p codex-supervisor --lib
          cargo test -p codex-deep-research --lib
```

## 🚀 次のステップ

### 1. 基本テストの実施
- [ ] テスト1-5を実行
- [ ] 結果を記録

### 2. 高度なテストの実施
- [ ] テスト6（マルチエージェント）を実行
- [ ] CI/CD統合を検討

### 3. 本番環境への導入
- [ ] チームでレビュー
- [ ] セキュリティ監査
- [ ] 段階的ロールアウト

---

**作成日時**: 2025-10-08 03:20 JST  
**バージョン**: codex-cli 0.0.0 (独自ビルド)  
**ステータス**: ✅ Ready for Production Testing

**安全で効果的なテストを！** 🔒✨

